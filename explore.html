<!DOCTYPE html>
<html>
<head>
  <title>Leaflet Map with Google Sheets Data</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>
  <style>
    body {
      padding: 0;
      margin: 0;
    }
    html, body, #map {
      height: 100%;
      width: 100vw;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
  <script>
    // Initialize the map
    const map = L.map('map').setView([17.4065, 78.4772], 10); // Centered on hyderabad

    // Add a tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'rishi ralla'
    }).addTo(map);

    // Fetch the JSON data from Google Sheets
    fetch('https://docs.google.com/spreadsheets/d/1ajnO27PRxnHSQiRhyVpukeir-zqTcUfK7F_kfM1nfkc/gviz/tq?tqx=out:json')
      .then(response => response.text())
      .then(text => {
        // Parse the JSON data
        const json = JSON.parse(text.substring(47).slice(0, -2)); // Remove callback function and trailing })
        const rows = json.table.rows;

        // Loop through the rows and add markers
        rows.forEach(row => {
          const timestamp = row.c[0] ? row.c[0].v : ''; // Timestamp
          const title = row.c[1] ? row.c[1].v : ''; // Title
          const description = row.c[2] ? row.c[2].v : ''; // Description
          const lat = parseFloat(row.c[3].v); // Latitude
          const lng = parseFloat(row.c[4].v); // Longitude
          const imageUrl = row.c[5] ? row.c[5].v : ''; // Image URL

          if (!isNaN(lat) && !isNaN(lng)) {
            const popupContent = `
              <div class="popup-content">
                <h4>${title}</h4>
                <p>${description}</p>
                ${imageUrl ? `<img src="${imageUrl}" alt="Image" style="width: 100px;">` : ''}
                <p><strong>Timestamp:</strong> ${timestamp}</p>
              </div>
            `;
            L.marker([lat, lng]).addTo(map).bindPopup(popupContent);
          }
        });
      })
      .catch(error => console.error('Error fetching data:', error));
      
    // Adding search geocoding
    var geocoder = L.Control.geocoder().addTo(map);

    // Adding current location
    map.locate({setView: true, maxZoom: 16});
    function onLocationFound(e) {
      var radius = e.accuracy;
      L.marker(e.latlng).addTo(map)
        .bindPopup("You are within " + radius + " meters from this point").openPopup();
    }

    map.on('locationfound', onLocationFound);

    function onLocationError(e) {
      alert(e.message);
    }

    map.on('locationerror', onLocationError);
  </script>
</body>
</html>